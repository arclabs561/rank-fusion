name: Publish WASM

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check version consistency
        run: |
          ROOT_VERSION=$(grep '^version = ' Cargo.toml | cut -d'"' -f2)
          PKG_VERSION=$(grep '"version"' rank-fusion/rank-fusion/pkg/package.json 2>/dev/null | cut -d'"' -f4 || echo "")
          
          if [ -n "$PKG_VERSION" ] && [ "$PKG_VERSION" != "$ROOT_VERSION" ]; then
            echo "⚠️  Package.json version ($PKG_VERSION) differs from root ($ROOT_VERSION)"
            echo "This is expected if package.json hasn't been rebuilt yet"
          fi
          
          echo "✅ Version check complete: $ROOT_VERSION"
      - name: Run tests
        run: |
          # Exclude evals from workspace to avoid rank-eval dependency issue
          # evals is not needed for WASM publishing
          cargo test -p rank-fusion --workspace --exclude rank-fusion-evals
      - name: Test WASM feature compiles
        run: cargo check --features wasm -p rank-fusion --workspace --exclude rank-fusion-evals
      - name: Run clippy
        run: cargo clippy --workspace --exclude rank-fusion-evals -- -D warnings
      - name: Check formatting
        run: cargo fmt --check --all -- --exclude rank-fusion-evals || cargo fmt --check

  publish-npm:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install wasm32 target
        run: rustup target add wasm32-unknown-unknown
      - name: Install wasm-pack
        run: |
          curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Build WASM package
        working-directory: rank-fusion/rank-fusion
        run: |
          wasm-pack build --target nodejs --out-dir pkg --scope arclabs561 --release -- --features wasm
        continue-on-error: false
      - name: Optimize WASM binary with wasm-opt
        working-directory: rank-fusion/rank-fusion/pkg
        continue-on-error: true
        run: |
          # Install wasm-opt if not available (optional optimization step)
          if ! command -v wasm-opt &> /dev/null; then
            echo "Installing wasm-opt for size optimization..."
            BINARYEN_VERSION="version_116"
            curl -L "https://github.com/WebAssembly/binaryen/releases/download/${BINARYEN_VERSION}/binaryen-${BINARYEN_VERSION}-x86_64-linux.tar.gz" -o binaryen.tar.gz || {
              echo "⚠️  Failed to download wasm-opt, skipping optimization (not critical)"
              exit 0
            }
            tar -xzf binaryen.tar.gz
            export PATH="$PWD/binaryen-${BINARYEN_VERSION}/bin:$PATH"
            rm binaryen.tar.gz
          fi
          # Optimize for size (-Oz = aggressive size optimization, saves 15-20%)
          if [ -f "rank_fusion_bg.wasm" ] && command -v wasm-opt &> /dev/null; then
            INITIAL_SIZE=$(stat -c%s rank_fusion_bg.wasm 2>/dev/null || stat -f%z rank_fusion_bg.wasm 2>/dev/null || echo "0")
            wasm-opt -Oz -o rank_fusion_bg.wasm.opt rank_fusion_bg.wasm && {
              mv rank_fusion_bg.wasm.opt rank_fusion_bg.wasm
              FINAL_SIZE=$(stat -c%s rank_fusion_bg.wasm 2>/dev/null || stat -f%z rank_fusion_bg.wasm 2>/dev/null || echo "0")
              if [ "$INITIAL_SIZE" != "0" ] && [ "$FINAL_SIZE" != "0" ]; then
                SAVED=$((INITIAL_SIZE - FINAL_SIZE))
                PERCENT=$((SAVED * 100 / INITIAL_SIZE))
                echo "✅ WASM binary optimized: ${INITIAL_SIZE} → ${FINAL_SIZE} bytes (saved ${SAVED} bytes, ${PERCENT}%)"
              else
                echo "✅ WASM binary optimized"
              fi
            } || {
              echo "⚠️  wasm-opt optimization failed, using original binary (not critical)"
            }
          else
            echo "ℹ️  Skipping wasm-opt optimization (file not found or tool unavailable)"
          fi
      - name: Verify WASM package was built
        working-directory: rank-fusion/rank-fusion/pkg
        run: |
          if [ ! -f "package.json" ]; then
            echo "❌ package.json not found - wasm-pack build may have failed"
            exit 1
          fi
          if [ ! -f "rank_fusion_bg.wasm" ]; then
            echo "❌ WASM file not found - build may have failed"
            exit 1
          fi
          # Check WASM file size for sanity check
          WASM_SIZE=$(stat -f%z rank_fusion_bg.wasm 2>/dev/null || stat -c%s rank_fusion_bg.wasm 2>/dev/null || echo "unknown")
          echo "✅ WASM package built successfully (size: ${WASM_SIZE} bytes)"
      - name: Fix package.json for npm best practices
        working-directory: rank-fusion/rank-fusion/pkg
        run: |
          # npm prefers git+https:// format, wasm-pack generates https://
          # Also ensure files field is set for better package distribution
          node -e "
            const fs = require('fs');
            try {
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              let modified = false;
              
              // Fix repository URL format
              if (pkg.repository && typeof pkg.repository === 'object' && pkg.repository.url && typeof pkg.repository.url === 'string' && !pkg.repository.url.startsWith('git+')) {
                pkg.repository.url = 'git+' + pkg.repository.url;
                modified = true;
              }
              
              // Ensure files field includes necessary files (wasm-pack should set this, but verify)
              if (!pkg.files || !Array.isArray(pkg.files)) {
                pkg.files = ['*.wasm', '*.js', '*.d.ts', '*.ts', 'LICENSE*', 'README.md'];
                modified = true;
              }
              
              if (modified) {
                fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
                console.log('✅ Fixed package.json (repository URL and files field)');
              } else {
                console.log('ℹ️  package.json already in correct format');
              }
            } catch (error) {
              console.error('❌ Failed to fix package.json:', error.message);
              exit 1;
            }
          "
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Ensure npm 11.5.1+ for OIDC
        run: npm install -g npm@latest
      - name: Publish to npm
        working-directory: rank-fusion/rank-fusion/pkg
        run: npm publish --access public
        # OIDC trusted publisher configured - no token needed
